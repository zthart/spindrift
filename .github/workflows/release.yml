name: Tag a dev release on GitHub using the current version according to Cargo.toml
on:
  push:
    branches: [ main ]
jobs:
  make-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.generate-tag.outputs.tag-name }}
    steps:
      - name: Checkout Spindrift
        uses: actions/checkout@v3

      - name: generate tag
        id: generate-tag
        run: |
          echo "## Creating Tag" >> $GITHUB_STEP_SUMMARY
          candidate-tag=$(grep '^version' Cargo.toml | awk '{print $3}' | sed -r 's/\"//g')-dev+$(date +%y%m%d)
          echo "**`$CANDIDATE_TAG`**: $candidate-tag" >> $GITHUB_STEP_SUMMARY
          needed-part=$(git show-ref --tags -d | grep $candidate-tag | wc -l)
          echo "**`$NEEDED_PART`**: $needed-part" >> $GITHUB_STEP_SUMMARY
          if [ $needed-part -eq 0 ] ; then
            echo "::set-output name=tag-name::$candidate-tag"
            echo "Using tag name `$candidate-tag`" >> $GITHUB_STEP_SUMMARY
          else
            echo "::set-output name=tag-name::$candidate-tag.$needed-part"
            echo "Using tag name `$candidate-tag.$needed-part`" >> $GITHUB_STEP_SUMMARY
          fi
        
      - name: tag a release
        run: |
          git tag ${{ steps.generate-tag.outputs.tag-name }}
          git push origin tag ${{ steps.generate-tag.outputs.tag-name }}

